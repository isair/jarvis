name: Release

on:
  push:
    branches:
      - main
      - develop

jobs:
  # Semantic versioning analysis (main only)
  semantic-release:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
      new_release_git_tag: ${{ steps.semantic.outputs.new_release_git_tag }}

    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install semantic-release
        run: |
          npm install -g semantic-release@22 \
            @semantic-release/github@9 \
            conventional-changelog-conventionalcommits@7

      - name: ğŸ·ï¸ Semantic Release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run semantic-release and capture output
          npx semantic-release --debug > release_output.log 2>&1 || true

          # Check if a release was created
          if grep -q "Published release" release_output.log; then
            echo "new_release_published=true" >> $GITHUB_OUTPUT
            # Extract version from the log
            VERSION=$(grep "Published release" release_output.log | sed -n 's/.*Published release \([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
            echo "new_release_version=$VERSION" >> $GITHUB_OUTPUT
            echo "new_release_git_tag=v$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… Released version $VERSION"
          else
            echo "new_release_published=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No release created (no releasable changes found)"
          fi

          # Show the full log for debugging
          cat release_output.log

  # Build desktop apps for all platforms
  build-windows:
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install requirements but skip heavy optional packages (PyTorch, etc.)
          # Filter out chatterbox-tts and mlx-whisper (heavy/platform-specific)
          Get-Content requirements.txt | Where-Object { $_ -notmatch '^(chatterbox-tts|mlx-whisper)' } | Set-Content requirements-desktop.txt
          pip install -r requirements-desktop.txt
          pip install pyinstaller

      - name: ğŸ¨ Generate icons
        run: |
          python src/jarvis/desktop_assets/generate_icons.py

      - name: ğŸ”¨ Build executable
        run: |
          pyinstaller jarvis_desktop.spec

      - name: ğŸ“¦ Package Windows build
        run: |
          cd dist
          Compress-Archive -Path Jarvis.exe -DestinationPath Jarvis-Windows-x64.zip

      - name: ğŸ“¤ Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: Jarvis-Windows
          path: dist/Jarvis-Windows-x64.zip

  build-macos:
    runs-on: macos-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install requirements but skip heavy optional packages (PyTorch/Chatterbox)
          # MLX Whisper is included - it's lightweight and provides fast speech recognition on Apple Silicon
          grep -v -E '^chatterbox-tts' requirements.txt > requirements-desktop.txt
          pip install -r requirements-desktop.txt
          pip install pyinstaller

      - name: ğŸ¨ Generate icons
        run: |
          python src/jarvis/desktop_assets/generate_icons.py

      - name: ğŸ”¨ Build application
        run: |
          pyinstaller jarvis_desktop.spec

      - name: ğŸ” Ad-hoc code sign the app
        run: |
          # Ad-hoc sign all binaries in the app bundle for macOS compatibility
          codesign --force --deep --sign - dist/Jarvis.app || true

      - name: ğŸ“¦ Package macOS build
        run: |
          cd dist
          # Detect architecture and name zip accordingly
          ARCH=$(uname -m)
          if [ "$ARCH" = "arm64" ]; then
            zip -r Jarvis-macOS-arm64.zip Jarvis.app
          else
            zip -r Jarvis-macOS-x64.zip Jarvis.app
          fi

      - name: ğŸ“¤ Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: Jarvis-macOS
          path: dist/Jarvis-macOS-*.zip

  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¹ Free up disk space
        run: |
          # Remove unnecessary large packages to free up disk space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-cursor0 libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-shape0 portaudio19-dev binutils

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # Install requirements but skip heavy optional packages (PyTorch, etc.)
          grep -v -E '^(chatterbox-tts|mlx-whisper)' requirements.txt > requirements-desktop.txt
          pip install -r requirements-desktop.txt
          pip install pyinstaller

      - name: ğŸ¨ Generate icons
        run: |
          python src/jarvis/desktop_assets/generate_icons.py

      - name: ğŸ”¨ Build executable
        run: |
          pyinstaller jarvis_desktop.spec

      - name: ğŸ“¦ Package Linux build
        run: |
          cd dist
          # Package the Jarvis directory (not a single file anymore)
          tar -czf Jarvis-Linux-x64.tar.gz Jarvis/

      - name: ğŸ“¤ Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: Jarvis-Linux
          path: dist/Jarvis-Linux-x64.tar.gz

  # Create versioned release (main only, if semantic-release published)
  release-main:
    needs: [semantic-release, build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && needs.semantic-release.outputs.new_release_published == 'true'

    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“ Attach binaries to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.semantic-release.outputs.new_release_git_tag }}
          files: |
            artifacts/Jarvis-Windows/Jarvis-Windows-x64.zip
            artifacts/Jarvis-macOS/Jarvis-macOS-*.zip
            artifacts/Jarvis-Linux/Jarvis-Linux-x64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Create/update latest pre-release (develop only)
  release-develop:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“ Create/Update Latest Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Development Build
          files: |
            artifacts/Jarvis-Windows/Jarvis-Windows-x64.zip
            artifacts/Jarvis-macOS/Jarvis-macOS-*.zip
            artifacts/Jarvis-Linux/Jarvis-Linux-x64.tar.gz
          draft: false
          prerelease: true
          body: |
            ğŸš€ **Latest development build from develop branch**

            This is an automated build from the latest commit on develop.
            These builds may be unstable. For stable releases, use versioned releases.

            ### ğŸ“¦ Downloads:
            - **Windows**: Jarvis-Windows-x64.zip
            - **macOS**: Jarvis-macOS-x64.zip
            - **Linux**: Jarvis-Linux-x64.tar.gz

            **Branch**: develop
            **Commit**: ${{ github.sha }}
            **Date**: ${{ github.event.head_commit.timestamp }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

