import pytest
from jarvis.config import get_default_config, load_settings


@pytest.mark.unit
def test_default_config_contains_filesystem_home():
    cfg = get_default_config()
    assert isinstance(cfg.get("mcps"), dict)
    assert "filesystem-home" in cfg["mcps"]
    fs = cfg["mcps"]["filesystem-home"]
    assert fs.get("transport") == "stdio"
    assert fs.get("command") in ("npx", "npx")


@pytest.mark.unit
def test_load_settings_normalizes_mcps(monkeypatch, tmp_path):
    # Write a minimal config that overrides mcps with a list of dicts using name field
    cfg_path = tmp_path / "config.json"
    cfg_path.write_text(
        """
        {
          "mcps": [
            {"name": "fs", "transport": "stdio", "command": "npx", "args": ["-y", "@modelcontextprotocol/server-filesystem", "~"], "env": {}}
          ],
          "ollama_base_url": "http://localhost",
          "ollama_embed_model": "x",
          "ollama_chat_model": "y"
        }
        """,
        encoding="utf-8",
    )

    # Point loader to our temporary config
    monkeypatch.setenv("JARVIS_CONFIG_PATH", str(cfg_path))
    s = load_settings()
    assert isinstance(s.mcps, dict)
    assert "fs" in s.mcps
    assert s.mcps["fs"]["transport"] == "stdio"

